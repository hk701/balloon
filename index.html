<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR çº¢è‰²æ°”çƒ</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    canvas {
      display: block;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="info">å¯¹ç€éº¦å…‹é£è¯´è¯é‡Šæ”¾çº¢è‰²æ°”çƒ ğŸˆ</div>
  
  <script type="module">
    import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';

    let scene, camera, renderer;
    let balloons = [];
    let video, videoTexture;
    let analyser, audioData;
    let audioContext;
    let isAudioReady = false;

    init();
    animate();

    function init() {
      // åˆ›å»ºåœºæ™¯
      scene = new THREE.Scene();
      
      // åˆ›å»ºç›¸æœº
      camera = new THREE.PerspectiveCamera(
        75, 
        window.innerWidth / window.innerHeight, 
        0.1, 
        1000
      );
      camera.position.z = 5;

      // åˆ›å»ºæ¸²æŸ“å™¨
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.body.appendChild(renderer.domElement);

      // æ·»åŠ å…‰ç…§
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 5, 5);
      scene.add(directionalLight);
      
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      // åˆå§‹åŒ–æ‘„åƒå¤´å’ŒéŸ³é¢‘
      initCameraAndAudio();

      // çª—å£å¤§å°è°ƒæ•´
      window.addEventListener('resize', onWindowResize);
    }

    async function initCameraAndAudio() {
      try {
        // è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // åç½®æ‘„åƒå¤´
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: true
        });

        // è®¾ç½®è§†é¢‘æµï¼ˆé™éŸ³ï¼Œé¿å…å›éŸ³ï¼‰
        video = document.createElement('video');
        video.srcObject = stream;
        video.setAttribute('playsinline', '');
        video.setAttribute('muted', ''); // ç¡®ä¿è§†é¢‘é™éŸ³
        video.muted = true; // åŒé‡ä¿è¯é™éŸ³
        video.play();

        video.onloadedmetadata = () => {
          // åˆ›å»ºè§†é¢‘çº¹ç†ä½œä¸ºèƒŒæ™¯
          videoTexture = new THREE.VideoTexture(video);
          videoTexture.minFilter = THREE.LinearFilter;
          videoTexture.magFilter = THREE.LinearFilter;
          scene.background = videoTexture;
        };

        // è®¾ç½®éŸ³é¢‘åˆ†æ
        setupAudio(stream);
        
      } catch (error) {
        console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´æˆ–éº¦å…‹é£:', error);
        document.getElementById('info').textContent = 'è¯·å…è®¸æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™';
        
        // è®¾ç½®é»˜è®¤èƒŒæ™¯è‰²
        scene.background = new THREE.Color(0x87CEEB); // å¤©è“è‰²
      }
    }

    function setupAudio(stream) {
      // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      // åˆ›å»ºéŸ³é¢‘æº
      const source = audioContext.createMediaStreamSource(stream);
      
      // åˆ›å»ºåˆ†æå™¨
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      analyser.smoothingTimeConstant = 0.3;
      
      // åªè¿æ¥åˆ°åˆ†æå™¨ï¼Œä¸è¿æ¥åˆ°æ‰¬å£°å™¨ï¼ˆé¿å…å›éŸ³ï¼‰
      source.connect(analyser);
      // é‡è¦ï¼šä¸è¦è¿æ¥åˆ° audioContext.destination
      
      // åˆ›å»ºæ•°æ®æ•°ç»„
      audioData = new Uint8Array(analyser.frequencyBinCount);
      
      isAudioReady = true;
      
      // å¤„ç†iOSçš„éŸ³é¢‘é™åˆ¶
      document.addEventListener('touchstart', () => {
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
      }, { once: true });
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function createBalloon() {
      // éšæœºä½ç½®å’Œå¤§å°
      const x = (Math.random() - 0.5) * 10;
      const z = -2 - Math.random() * 3;
      const scale = 0.5 + Math.random() * 1;
      
      // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰æ°”çƒé‡å 
      let overlapping = false;
      for (const balloon of balloons) {
        const distance = Math.sqrt(
          Math.pow(balloon.position.x - x, 2) + 
          Math.pow(balloon.position.z - z, 2)
        );
        if (distance < scale + balloon.userData.scale) {
          overlapping = true;
          break;
        }
      }
      
      if (overlapping) return;
      
      // åˆ›å»ºæ°”çƒç»„
      const balloonGroup = new THREE.Group();
      
      // æ°”çƒä¸»ä½“ï¼ˆçƒä½“ï¼‰
      const balloonGeometry = new THREE.SphereGeometry(0.5, 32, 16);
      const balloonMaterial = new THREE.MeshPhongMaterial({
        color: 0xff0000, // çº¢è‰²
        shininess: 100,
        specular: 0xffffff
      });
      const balloonMesh = new THREE.Mesh(balloonGeometry, balloonMaterial);
      balloonMesh.scale.y = 1.2; // ç¨å¾®æ‹‰é•¿ä½¿å…¶æ›´åƒæ°”çƒ
      balloonGroup.add(balloonMesh);
      
      // æ°”çƒç»³å­
      const ropeGeometry = new THREE.CylinderGeometry(0.01, 0.01, 1.5, 8);
      const ropeMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 });
      const ropeMesh = new THREE.Mesh(ropeGeometry, ropeMaterial);
      ropeMesh.position.y = -1;
      balloonGroup.add(ropeMesh);
      
      // è®¾ç½®ä½ç½®å’Œç¼©æ”¾
      balloonGroup.position.set(x, -5, z);
      balloonGroup.scale.set(scale, scale, scale);
      
      // æ·»åŠ ç”¨æˆ·æ•°æ®
      balloonGroup.userData = {
        speed: 0.01 + Math.random() * 0.02,
        swaySpeed: 1 + Math.random() * 2,
        swayAmount: 0.1 + Math.random() * 0.2,
        scale: scale
      };
      
      scene.add(balloonGroup);
      balloons.push(balloonGroup);
    }

    function updateBalloons() {
      const time = Date.now() * 0.001;
      
      for (let i = balloons.length - 1; i >= 0; i--) {
        const balloon = balloons[i];
        
        // ä¸Šå‡
        balloon.position.y += balloon.userData.speed;
        
        // å·¦å³æ‘‡æ‘†
        balloon.position.x += Math.sin(time * balloon.userData.swaySpeed) * 
                             balloon.userData.swayAmount * 0.01;
        
        // è½»å¾®æ—‹è½¬
        balloon.rotation.z = Math.sin(time * balloon.userData.swaySpeed) * 0.1;
        
        // ç§»é™¤é£å‡ºå±å¹•çš„æ°”çƒ
        if (balloon.position.y > 10) {
          scene.remove(balloon);
          balloons.splice(i, 1);
        }
      }
    }

    function checkAudioLevel() {
      if (!isAudioReady || !analyser) return;
      
      // è·å–éŸ³é¢‘æ•°æ®
      analyser.getByteFrequencyData(audioData);
      
      // è®¡ç®—å¹³å‡éŸ³é‡
      let sum = 0;
      for (let i = 0; i < audioData.length; i++) {
        sum += audioData[i];
      }
      const average = sum / audioData.length;
      
      // å¦‚æœéŸ³é‡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ›å»ºæ°”çƒï¼ˆæé«˜é˜ˆå€¼é¿å…ç¯å¢ƒå™ªéŸ³ï¼‰
      if (average > 40 && balloons.length < 20) {
        createBalloon();
        
        // æ·»åŠ å†·å´æ—¶é—´ï¼Œé¿å…ä¸€æ¬¡è§¦å‘å¤ªå¤šæ°”çƒ
        isAudioReady = false;
        setTimeout(() => {
          isAudioReady = true;
        }, 200); // 200ms å†·å´æ—¶é—´
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      
      // æ£€æŸ¥éŸ³é¢‘è§¦å‘
      checkAudioLevel();
      
      // æ›´æ–°æ°”çƒ
      updateBalloons();
      
      // æ¸²æŸ“åœºæ™¯
      renderer.render(scene, camera);
    }

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ä½œä¸ºå¤‡ç”¨è§¦å‘æ–¹å¼
    document.addEventListener('click', () => {
      if (balloons.length < 20) {
        createBalloon();
      }
    });
  </script>
</body>
</html>
